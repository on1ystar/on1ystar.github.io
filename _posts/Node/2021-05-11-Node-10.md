---
layout: post
title: Node.js/Express Mongoose(ëª½êµ¬ìŠ¤)-CRUD-1
date: 2021-05-11 +0900
categories: [Node.js]
sitemap:
  changefreq: daily
  priority: 1.0
---

---

<br>

<div class="intro" >

ì˜ë¬¸ì ì´ë‚˜ ì§€ì  ë“±ì˜ ê´€ì‹¬ ë° ì¡°ì–¸ì„ ìœ„í•œ ëŒ“ê¸€ì´ë‚˜ ë©”ì¼ì€ ì–¸ì œë‚˜ í™˜ì˜ì´ê³  ê°ì‚¬í•©ë‹ˆë‹¤.

</div>

<br>

ë³¸ê²©ì ìœ¼ë¡œ **ëª½êµ¬ìŠ¤**ë¥¼ ì´ìš©í•´ ëª½ê³ DBë¥¼ ì œì–´í•˜ê¸° ìœ„í•´ì„œëŠ” ê°€ì¥ ë¨¼ì € **ìŠ¤í‚¤ë§ˆ(schema)**ë¥¼ ë§Œë“œëŠ” ê²ƒ ë¶€í„° ì‹œì‘ì´ë‹¤.

> ê° ìŠ¤í‚¤ë§ˆëŠ” MongoDB ì»¬ë ‰ì…˜ì— ë§¤í•‘ë˜ê³  í•´ë‹¹ ì»¬ë ‰ì…˜ ë‚´ì—ì„œ ë¬¸ì„œì˜ ëª¨ì–‘ì„ ì •ì˜í•œë‹¤.

ì‚¬ì‹¤ NoSQLì¸ MongoDBëŠ” ë¬¸ì„œ ë‚´ì— ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•  í•„ìš”ê°€ ì—†ë‹¤. ë•Œë¬¸ì— ì–´ë–¤ ë°ì´í„°ë¥¼ ë„£ì–´ë„ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•ŠëŠ”ë°, ì´ëŠ” ì¥ì ì´ì ë‹¨ì ì´ë‹¤. ì˜¤íƒ€ë¥¼ ë‚¸ ë°ì´í„°ë‚˜ ì‹¤ìˆ˜ë¡œ ê°™ì€ í•„ë“œì— ë‹¤ë¥¸ íƒ€ì…ì˜ ë°ì´í„°ë¥¼ ë„£ëŠ” ë“±ì˜ ì‹¤ìˆ˜ë¥¼ ë²”í•  ìˆ˜ ìˆë‹¤.

ëª½êµ¬ìŠ¤ëŠ” ì´ëŸ¬í•œ ë¬¸ì œë¥¼ ë§‰ê¸° ìœ„í•´ ì‚¬ìš©ìê°€ ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•  ìˆ˜ ìˆê²Œ í•˜ì—¬, DBì— ë°ì´í„°ë¥¼ ë„£ê¸° ì „ì— ë¨¼ì € ê²€ì‚¬ë¥¼ í•œë‹¤. ë•Œë¬¸ì— í•„ìš”ì— ë”°ë¼ ë§¤ìš° ìœ ìš©í•˜ê²Œ ìŠ¤í‚¤ë§ˆë¥¼ í™œìš©í•  ìˆ˜ ìˆë‹¤.

ê·¸ë ‡ë‹¤ê³  ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•˜ëŠ” ê²Œ ê·€ì°®ê±°ë‚˜ ê¹Œë‹¤ë¡­ì§€ ì•Šë‹¤. **Mongoose**ë¥¼ ì´ìš©í•˜ë©´ JavaScript ë¬¸ë²•ìœ¼ë¡œ, ê²Œë‹¤ê°€ ê±°ì˜ ëŒ€ë¶€ë¶„ì˜ **JavaScriptì˜ ìë£Œí˜•**ê¹Œì§€ ê·¸ëŒ€ë¡œ **í•„ë“œì˜ ë°ì´í„° íƒ€ì…ìœ¼ë¡œ ì‚¬ìš©**í•  ìˆ˜ ìˆë‹¤.

<br>

### ğŸ“Œ ëª½êµ¬ìŠ¤ ìŠ¤í‚¤ë§ˆ íƒ€ì…

- `mongoose.Schema.Types.String`
- `mongoose.Schema.Types.Number`
- `mongoose.Schema.Types.Date`
- `mongoose.Schema.Types.Buffer`
- `mongoose.Schema.Types.Boolean`
- `mongoose.Schema.Types.Mixed`
- `mongoose.Schema.Types.ObjectId`Â (or, equivalently,Â `mongoose.ObjectId`)
- `mongoose.Schema.Types.Array`
- `mongoose.Schema.Types.Decimal128`
- `mongoose.Schema.Types.Map`

```jsx
// https://kb.objectrocket.com/mongo-db/mongoose-schema-types-1418
const schema = new Schema({
                name : String, //String
                age : Number, //Number
                dateOfBirth: Date, //Date
                Id: mongoose.ObjectIds //ObjectIds
                onSite: true, //Boolean
                locations: [String], //Array
                Data: Buffer, //Buffer
                others : Schema.Types.Mixed, //Mixed
                supervisorOf : {
                    type: map //map
                    of:  String
                }
            })
```

<br>

### ì‹¤ìŠµì„ ìœ„í•œ ë””ë ‰í† ë¦¬ êµ¬ì¡°(ì´ì „ í¬ìŠ¤íŒ…ë“¤ ì°¸ê³ )

```jsx
/* Working Directory
â”Œâ”€â”€node_modules
â”œâ”€â”¬src
â”‚ â”œâ”€â”¬controllers
â”‚ â”‚ â”œâ”€â”€userController.js
â”‚ â”‚ â””â”€â”€videoController.js
â”‚ â”œâ”€â”¬routers
â”‚ â”‚ â”œâ”€â”€globalRouter.js
â”‚ â”‚ â”œâ”€â”€userRouter.js
â”‚ â”‚ â””â”€â”€videoRouter.js
â”‚ â”œâ”€â”¬views   
â”‚ â”‚ â”œâ”€â”¬partial
â”‚ â”‚ â”‚ â””â”€â”€footer.pug  
â”‚ â”‚ â”œâ”€â”€base.pug
â”‚ â”‚ â”œâ”€â”€home.pug
â”‚ â”‚ â”œâ”€â”€videoEdit.pug
â”‚ â”‚ â””â”€â”€watch.pug
â”‚ â””â”€â”¬models
â”‚   â””â”€â”€Video.js  <----- ì¶”ê°€
â”œâ”€â”€server.js
â”œâ”€â”€init.js   <----- ì¶”ê°€
â””â”€â”€pakage.json
*/
```

<br>
<div class="t-t-c text-shadow-blue"><h2>â˜„ Create Model</h2></div>
<br>

---

ë¨¼ì € `Video` ëª¨ë¸ì„ ë§Œë“¤ê¸° ìœ„í•´ `Video.js` íŒŒì¼ì— ìŠ¤í‚¤ë§ˆë¶€í„° ì •ì˜í•œë‹¤. ëª¨ë¸ì„ ë§Œë“¤ ë•ŒëŠ” ê·¸ ëŒ€ìƒì˜ ìƒê¹€ìƒˆ, íŠ¹ì§•ë“¤ì„ ìµœëŒ€í•œ ìì„¸í•˜ê²Œ ë‚˜íƒ€ë‚´ëŠ”ê²Œ ì¤‘ìš”í•˜ë‹¤. ì–´ëŠ ì •ë„ ì¶”ìƒí™”ê°€ ëë‚¬ìœ¼ë©´ ê·¸ íŠ¹ì§•ë“¤ì„ ë°ì´í„°ì˜ í˜•ì‹ìœ¼ë¡œ ì •ì˜í•œë‹¤.

```jsx
// models/Video.js
import mongoose from "mongoose";

const videoSchema = new mongoose.Schema({
  title: String,
  description: String,
  createdAt: Date,
  hashtags: [String],
  meta: {
    views: Number,
    rating: Number,
  },
});

const Video = mongoose.model("Video", videoSchema);

export default Video;
```

`mongoose.Schema` ê°ì²´ë¥¼ ë¨¼ì € ì •ì˜í•œë‹¤. `JavaScript Object` í˜•íƒœë¡œ ìŠ¤í‚¤ë§ˆì˜ í˜•íƒœë¥¼ ì •ì˜í•˜ë©´, ì¶”í›„ ì‚¬ìš©ë˜ëŠ” DB ì»¬ë ‰ì…˜ì— ë§¤í•‘ë˜ì–´ ë¬¸ì„œ ëª¨ì–‘ì´ ì •ì˜ëœë‹¤.

ì´ì œ `mongoose.model` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•´ ëª¨ë¸ ëª… `Video`ê³¼ ìŠ¤í‚¤ë§ˆ `videoSchema`ë¥¼ ì¸ìë¡œ ë„£ì–´ì£¼ë©´ DBì— ë§¤í•‘í•  ìˆ˜ ìˆëŠ” ìŠ¤í‚¤ë§ˆ ëª¨ë¸ì´ ìƒì„±ëœë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ ëª¨ë¸ì„ DBì— ì•Œë¦¬ê¸° ìœ„í•´ì„œ `import` í•´ ì¤˜ì•¼ í•˜ëŠ”ë°, ê·¸ ìœ„ì¹˜ëŠ” DBë¥¼ ì„¸íŒ…í•œ íŒŒì¼ì„ `import`í•œ ë‹¤ìŒ ìœ„ì¹˜ì—¬ì•¼ í•œë‹¤.

```jsx
// server.js
import "./db";
import "./models/Video";
// ... ìƒëµ
```

**ê·¸ë˜ì•¼ serverê°€ ì‹œì‘ëœ í›„ DBê°€ ì„¸íŒ…ë˜ê³ , ê·¸ ì„¸íŒ…ëœ DBì— ìƒì„±í•´ ë†“ì€ modelì„ ì»´íŒŒì¼ ì‹œí‚¤ëŠ” íë¦„**ì´ ëœë‹¤.

ì°¸ê³ ë¡œ ì—¬ê¸°ì„œ server.jsì˜ ì¼ë¶€ë¶„ì„ init.jsë¡œ ì˜®ê¸¸ê±´ë°, ê·¸ ì´ìœ ëŠ” ìœ„ì—ì„œ ì²˜ëŸ¼ dbì™€ ê´€ë ¨ëœ `import`ë“¤ì´ ë§ì•„ì§ˆ ìˆ˜ ë°–ì— ì—†ê³ , ì‚¬ì‹¤ ê·¸ëŸ° ë¶€ë¶„ë“¤ì€ serverì˜ configurationê³¼ëŠ” ì¢€ ë¬´ê´€í•œ ëŠë‚Œì´ê¸° ë•Œë¬¸ì´ë‹¤.

ë”°ë¼ì„œ server.jsì—ëŠ” **serverì˜ configurationê³¼ ê°™ì€** `import` **ë° middleware í•¨ìˆ˜ë“¤**ì„ ì‘ì„±í•˜ê³ , init.jsì—ëŠ” **serverë¥¼ ì‹œì‘í•˜ê³ , ê·¸ëŸ¬ëŠ” ë™ì‹œì— DBì™€ modelë“¤ì„** `import` **í•´ì„œ ì—°ë™ì‹œí‚¤ëŠ” ì½”ë“œë“¤**ì„ ì‘ì„±í•œë‹¤.

```jsx
//init.js
import "./db";
import "./models/Video";
import app from "./server"; // server.jsì—ì„œ export default appì„ í•´ì¤˜ì•¼ í•¨

const PORT = 4000;

app.listen(PORT, () =>
  console.warn(`âœ… Server listening on http://127.0.0.1:${PORT}/`)
);
```

<br>
<div class="t-t-c text-shadow-blue"><h2>## â˜„ Mongoose Queries</h2></div>
<br>

---

> Mongoose ëª¨ë¸ì€ CRUD ì‘ì—…ì„ ìœ„í•œ **ì¿¼ë¦¬ ê°œì²´**ë“¤ì„ ë°˜í™˜í•˜ëŠ” ëª‡ ê°€ì§€ í•¨ìˆ˜ë“¤ì„ ì œê³µí•œë‹¤.

â†’ [queries list](https://mongoosejs.com/docs/queries.html)

ì´ ì¿¼ë¦¬ë“¤ì€ í¬ê²Œ 2ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ”ë°, `callback` í•¨ìˆ˜ì™€ `promise`ë‹¤.

### callback function

`find` ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•´ ìœ„ ë‘ ë°©ë²•ì˜ ì°¨ì´ë¥¼ ì•Œì•„ë³´ê² ë‹¤.

> `find(filter: FilterQuery<Document<any, {}>>, callback?: (err: any, docs: Document<any, {}>[])`ëŠ” `filter`ì— ë§¤ì¹­ë˜ëŠ” `documents` ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•œë‹¤.

```jsx
// controllers/videoController.js
import Video from "../models/Video";

export const home = (req, res) => {
  Video.find({}, (err, videos) => {
    console.log("error: ", err);
    console.log("videos:", videos);
  });
  res.render("home", { pageTitle: "Home", videos: {} });
};
```

`find`ì—ì„œ í˜¸ì¶œë˜ëŠ” `callback` í•¨ìˆ˜ëŠ” 2ê°œì˜ ì‹œê·¸ë‹ˆì²˜ íŒŒë¼ë¯¸í„°ë¥¼ ê°€ì§€ê³  ìˆëŠ”ë° **ì²« ë²ˆì§¸ì—ëŠ” ì—ëŸ¬ê°€** ë‹´ê²¨ ìˆê³ , **ë‘ ë²ˆì§¸ì—ëŠ” ì¡°íšŒí•œ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸**ë“¤ì´ ë‹´ê²¨ ìˆë‹¤. ì´ë¥¼ ë¡œê·¸ë¡œ ì°ì–´ë³´ë©´ ì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ê°€ ì¶œë ¥ë˜ëŠ”ë°, ì´ëŠ” ì‹¤ì œ DBì™€ ì˜ ì—°ë™ë˜ì–´ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í–ˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

<img src="{{'/public/img/node/node-10-1.png'}}">

ê·¸ëŸ°ë° ìì„¸íˆ ë³´ë©´ ì´ìƒí•œ ì ì„ ë°œê²¬í•  ìˆ˜ ìˆë‹¤. `morgan`ì´ ì°ì€ ë¡œê·¸ ì •ë³´ê°€ ì¿¼ë¦¬ ìˆ˜í–‰ì˜ ê²°ê³¼ ë¡œê·¸ë³´ë‹¤ ë¨¼ì € ì¶œë ¥ë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆëŠ”ë°, ì´ëŠ” ë‹¤ì‹œ ë§í•˜ë©´ `res.render('home', { pageTitle: 'Home', videos: {} });` ì½”ë“œê°€ ë’¤ì— ìˆìŒì—ë„ ë¨¼ì € ìˆ˜í–‰ë˜ì–´ **http requestì— ë Œë”ë§ì´ ëë‚œ responseë¥¼ í•œ í›„ ì¿¼ë¦¬ ìˆ˜í–‰ì´ ì™„ë£Œ** ëë‹¤ëŠ” ê²ƒì´ë‹¤.

ì´ë ‡ê²Œ ì‹¤í–‰ íë¦„ì´ ì—­ì „ëœ ì´ìœ ê°€ MongooseëŠ” ì¿¼ë¦¬ë¥¼ **ë¹„ ë™ê¸°ì **(**asynchronously**)ìœ¼ë¡œ ì‹¤í–‰ì‹œí‚¤ê¸° ë•Œë¬¸ì´ë‹¤.

ì¿¼ë¦¬ëŠ” node ì„œë²„ì—ì„œ ëª¨ë‘ ì²˜ë¦¬ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ **ì ì‹œ DBì— ì ‘ì†í•´ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ëŠ” ë° ì•„ë¬´ë¦¬ ì§§ì€ ì‹œê°„ì´ë¼ë„ ì§€ì—°**ë  ìˆ˜ ë°–ì— ì—†ì§€ë§Œ ë‹¤ë¥¸ ì½”ë“œë“¤ì€ ê·¸ js íŒŒì¼ì—ì„œ ì‹¤í–‰ê³¼ ì™„ë£Œê°€ ì´ë¤„ì§„ë‹¤. ë”°ë¼ì„œ `callback`ì€ ë°ì´í„°ê°€ ì˜ ë„ì°©í•˜ë“ , ì–´ë–¤ ì—ëŸ¬ê°€ ë°œìƒí•˜ë“ , **ì¿¼ë¦¬ì˜ ìˆ˜í–‰ì´ ëª¨ë‘ ì™„ë£Œëœ í›„ì— í˜¸ì¶œ**ë˜ì•¼ í•˜ë¯€ë¡œ ìœ„ì™€ ê°™ì€ ê²°ê³¼ê°€ ë°œìƒí•œ ê²ƒì´ë‹¤.

ì´ëŸ° ê²½ìš° ë°ì´í„°ê°€ ë„ì°©í•˜ê¸°ë„ ì „ì— ë Œë”ë§ëœ í˜ì´ì§€ê°€ ì‘ë‹µë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ë¯€ë¡œ `callback` í•¨ìˆ˜ ì•ˆì—ì„œ ì‹¤í–‰ íë¦„ì— ë§ê²Œ í•´ì¤˜ì•¼ í•œë‹¤.

```jsx
// controllers/videoController.js
import Video from "../models/Video";

export const home = (req, res) => {
  Video.find({}, (err, videos) => {
    console.log("error: ", err);
    console.log("videos:", videos);
    res.render("home", { pageTitle: "Home", videos: {} }); // ìˆ˜ì • í›„
  });
};
```

<img src="{{'/public/img/node/node-10-2.png'}}">

### promise (async/await)

(**promise**, **async/await**ì— ëŒ€í•œ ë¬¸ë²•ì ì¸ ì„¤ëª…ì€ ì¶”í›„ í¬ìŠ¤íŒ…ì—ì„œ)

ëª½êµ¬ìŠ¤ ì¿¼ë¦¬ëŠ” í”„ë¡œë¯¸ìŠ¤ ê°ì²´ë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— async/awaitë¥¼ ì‚¬ìš©í•´ì„œ `callback`ì„ ì‚¬ìš©í•œëŠ” ê²ƒ ë³´ë‹¤ ì¢€ ë” ê°€ë…ì„± ìˆëŠ” ì½”ë“œë¡œ ë°”ê¿€ ìˆ˜ ìˆë‹¤.

```jsx
// controllers/videoController.js
export const home = async (req, res) => {
  try {
    const videos = await Video.find();
    console.log(videos);
    return res.render("home", { pageTitle: "Home", videos: {} });
  } catch (err) {
    console.log("Video.find error: ".err);
    return res.end();
  }
};
```

`Video.find()`ëŠ” `await` í‚¤ì›Œë“œ ë•ë¶„ì— `callback` í•¨ìˆ˜ì—†ì´ ì¿¼ë¦¬ ìˆ˜í–‰ì„ ê¸°ë‹¤ë ¸ë‹¤ê°€, ëë‚˜ë©´ `videos` ë³€ìˆ˜ì— ê²°ê³¼ ë°ì´í„°(`documents`)ë¥¼ ë‹´ëŠ”ë‹¤.

ìœ„ ë‘ ë°©ë²• ëª¨ë‘ ì¿¼ë¦¬ ìˆ˜í–‰ì´ ë‹¤ ëë‚  ë•Œ ê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸° ìœ„í•œ `JavaScript`ì˜ ì²˜ë¦¬ ë°©ì‹ì´ì§€ë§Œ ê°œë°œìì˜ ì…ì¥ì—ì„œ `callback`ì€ í•¨ìˆ˜ ì•ˆì— ì—¬ëŸ¬ ë¡œì§ë“¤ì„ ì‘ì„±í•˜ë‹¤ ë³´ë©´ ë¹„ ë™ê¸°ì²˜ë¦¬ì— ìµìˆ™í•˜ì§€ ì•Šì€ ê°œë°œìë“¤ì€ ì‹¤í–‰ íë¦„ì„ ì½ê¸° ì–´ë ¤ì›Œ ì‹¤ìˆ˜í•  ìš°ë ¤ê°€ ë§ê³ , ìµìˆ™í•œ ê°œë°œìë”ë¼ë„ ì½”ë“œ ì½ê¸°ê°€ ë¶ˆí¸í•˜ë‹¤.

í•˜ì§€ë§Œ `promise` ë°©ì‹ì€ `async` í‚¤ì›Œë“œê°€ ë‹¬ë¦° í•¨ìˆ˜ê°€ ë¹„ ë™ê¸°ì‹ìœ¼ë¡œ ì²˜ë¦¬ë˜ê³  ìˆë‹¤ëŠ” ê±¸ ì¸ì‹í•  ìˆ˜ ìˆê³ , ê·¸ í•¨ìˆ˜ ë‚´ì—ì„œ `await` í‚¤ì›Œë“œê°€ ë‹¬ë¦° ì½”ë“œê°€ ì‹¤í–‰ íë¦„ì„ ì²˜ë¦¬í•˜ëŠ” ë° ì¤‘ìš”í•œ í¬ì¸íŠ¸ë¼ëŠ” ê±¸ ë°”ë¡œ ìºì¹˜í•  ìˆ˜ ìˆë‹¤.

`error` ì²˜ë¦¬ëŠ” ìœ„ì™€ ê°™ì´ `try~catch` ë¬¸ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

_ë‹¤ìŒ í¬ìŠ¤íŒ…ì— ì´ì–´ì„œ..._

<br>

### Reference

[https://nomadcoders.co/wetube](https://nomadcoders.co/wetube)

[https://mongoosejs.com/docs/guide.html](https://mongoosejs.com/docs/guide.html)
